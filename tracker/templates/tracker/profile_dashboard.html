{% extends "base.html" %}

{% block content %}
<style>
    .poster-grid-item {
        transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
    }
    .poster-grid-item:hover {
        transform: scale(1.05);
        box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        z-index: 10;
    }
    .poster-img {
        width: 100%;
        aspect-ratio: 2 / 3;
        object-fit: cover;
        border-radius: 8px;
    }
    .rating-toggle {
        cursor: pointer;
    }
</style>

<div class="container my-5">
    <div class="row justify-content-center">
        <div class="col-lg-10 col-md-12">
            <div class="card shadow-lg p-4 rounded-3">
                
                <h2 class="card-title text-center mb-4 fw-bold text-primary">{% if is_self %}Your Profile{% else %}{{ profile_owner.username }}'s Profile{% endif %}</h2>


                <div class="row justify-content-center text-center mb-4">
                    <div class="col-md-6 mb-3"><div class="p-3 rounded-3 shadow-sm" style="background-color: #f0f0f0;"><h5 class="text-uppercase text-muted small fw-bolder">MOVIES SEEN</h5><p id="total-seen-movies-stat" class="text-success" style="font-size: 5rem; font-weight: 900; line-height: 1;">{{ total_seen_movies }}</p></div></div>
                    {% if is_self or friendship_status == 'FRIENDS' or friendship_status == 'REQUEST_RECEIVED' %}
                    <div class="col-md-6 mb-3"><div class="p-3 rounded-3 shadow-sm" style="background-color: #f0f0f0;"><h5 class="text-uppercase text-muted small fw-bolder">MOVIES RATED</h5><p class="text-primary" style="font-size: 5rem; font-weight: 900; line-height: 1;">{{ total_rated_movies }}</p></div></div>
                    {% endif %}
                </div>
                
                {% if not is_self %}
                    <div class="text-center mb-4">
                        {% if friendship_status == 'REQUEST_RECEIVED' %}<p class="text-muted">{{ profile_owner.username }} has sent you a friend request.</p><form method="post" action="{% url 'profile_dashboard' username=profile_owner.username %}">{% csrf_token %}<input type="hidden" name="request_id" value="{{ request_obj.id }}"><input type="hidden" name="next_url" value="{{ request.path }}"><button type="submit" name="accept_request" class="btn btn-success">Accept Request</button><button type="submit" name="decline_request" class="btn btn-danger ms-1">Decline</button></form>{% elif friendship_status == 'REQUEST_SENT' %}<button class="btn btn-secondary" disabled>Friend Request Sent</button>{% elif friendship_status == 'NOT_FRIENDS' %}<form method="post" action="{% url 'profile_dashboard' username=profile_owner.username %}">{% csrf_token %}<input type="hidden" name="user_id" value="{{ profile_owner.id }}"><input type="hidden" name="next_url" value="{{ request.path }}"><button type="submit" name="add_friend" class="btn btn-info">Add Friend</button></form>{% endif %}
                    </div>
                {% endif %}
                
                {% if is_self or friendship_status == 'FRIENDS' %}
                    <hr class="my-4">
                    <div class="mt-2">
                        <h3 class="mb-3 text-center">{% if is_self %}Your{% else %}{{ profile_owner.username }}'s{% endif %} Seen Movies Library</h3>
                        <div id="seen-movies-container" class="mb-3">{% include 'tracker/partials/seen_movies_grid.html' %}</div>
                        <div class="d-flex justify-content-between align-items-center" id="seen-movies-pagination-controls">
                            <button id="seen-prev-page" class="btn btn-sm btn-outline-secondary" disabled>Previous</button>
                            <span>Page <span id="seen-current-page">1</span> of <span id="seen-total-pages"></span></span>
                            <button id="seen-next-page" class="btn btn-sm btn-outline-secondary">Next</button>
                        </div>
                    </div>
                {% endif %}

                {% if is_self %}
                    <hr class="my-4">
                    <div class="row mt-4">
                        <div class="col-lg-7">
                            <h4 class="mb-3 border-bottom pb-2">Friends & Invites</h4>
                            {% if incoming_requests %}<h5 class="mt-2">Incoming Requests ({{ incoming_requests.count }})</h5><div class="list-group mb-4">{% for friend_req in incoming_requests %}<div class="list-group-item d-flex justify-content-between align-items-center"><a href="{% url 'profile_dashboard' username=friend_req.from_user.username %}" class="fw-bold text-decoration-none">{{ friend_req.from_user.username }}</a><form method="post" action="{% url 'my_profile' %}">{% csrf_token %}<input type="hidden" name="request_id" value="{{ friend_req.id }}"><input type="hidden" name="next_url" value="{{ request.path }}"><button type="submit" name="accept_request" class="btn btn-sm btn-success">Accept</button><button type="submit" name="decline_request" class="btn btn-sm btn-danger ms-1">Decline</button></form></div>{% endfor %}</div>{% endif %}
                            {% if sent_requests %}<h5 class="mt-2">Sent Requests ({{ sent_requests.count }})</h5><div class="list-group mb-4">{% for sent_req in sent_requests %}<div class="list-group-item d-flex justify-content-between align-items-center"><span>To: <a href="{% url 'profile_dashboard' username=sent_req.to_user.username %}">{{ sent_req.to_user.username }}</a></span><form method="post" action="{% url 'my_profile' %}">{% csrf_token %}<input type="hidden" name="request_id" value="{{ sent_req.id }}"><input type="hidden" name="next_url" value="{{ request.path }}"><button type="submit" name="cancel_request" class="btn btn-sm btn-warning">Cancel</button></form></div>{% endfor %}</div>{% endif %}
                            <h5 class="mt-2">Friends ({{ friends_list.count }})</h5>
                            <div class="list-group mb-4">
                                {% for friendship in friends_list %}<div class="list-group-item d-flex justify-content-between align-items-center"><div><a href="{% url 'profile_dashboard' username=friendship.to_user.username %}" class="text-decoration-none fw-bold">{{ friendship.to_user.username }}</a>{% if friendship.to_user.id in invited_friend_ids %}<span class="ms-2" title="You invited this friend!"><i class="bi bi-envelope-check-fill text-success"></i></span>{% endif %}</div><form method="post" action="{% url 'my_profile' %}" class="d-inline">{% csrf_token %}<input type="hidden" name="remove_friend_id" value="{{ friendship.to_user.id }}"><button type="submit" name="remove_friend" class="btn btn-sm btn-danger">Remove</button></form></div>{% empty %}<p class="text-muted small p-2">You haven't added any friends yet.</p>{% endfor %}
                            </div>
                            <h5 class="mt-4">Invite Links</h5>
                            <div style="max-width: 400px;">
                                {% for code in available_codes %}{% url 'signup_with_code' invite_code=code.code as signup_link %}<div class="input-group mb-2"><input type="text" class="form-control form-control-sm" value="{{ request.scheme }}://{{ request.get_host }}{{ signup_link }}" readonly id="invite-link-{{ code.id }}"><button class="btn btn-sm btn-outline-secondary" type="button" onclick="copyCode('invite-link-{{ code.id }}')">Copy</button></div>{% empty %}<p class="text-muted small">You have no available invite codes. Keep rating movies to earn more!</p>{% endfor %}
                            </div>
                        </div>
                        <div class="col-lg-5">
                            <h4 class="mb-3 border-bottom pb-2">Recently Rated</h4>
                            <div id="last-rated-container">{% include 'tracker/partials/last_rated_list.html' %}</div>
                            <div class="d-flex justify-content-between mt-2" id="pagination-controls">
                                <button id="prev-page" class="btn btn-sm btn-outline-secondary" disabled>Previous</button>
                                <span>Page <span id="current-page">1</span> of <span id="total-pages"></span></span>
                                <button id="next-page" class="btn btn-sm btn-outline-secondary">Next</button>
                            </div>
                        </div>
                    </div>
                    <hr class="my-4">
                    <div class="mt-2">
                         <h4 class="mb-3 border-bottom pb-2">Account Details</h4>
                         <div class="row small text-muted">
                             <div class="col-sm-6 mb-2"><strong>Email:</strong> {{ user.email }}</div>
                             <div class="col-sm-6 mb-2"><strong>Date of Birth:</strong> {{ profile.date_of_birth|date:"F j, Y" }}</div>
                             <div class="col-sm-6 mb-2"><strong>Joined:</strong> {{ profile.join_date|date:"F j, Y" }}</div>
                             <div class="col-sm-6 mb-2"><strong>Last Activity:</strong> {{ profile.last_activity|timesince }} ago</div>
                         </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // --- PART 1: LOGIC FOR "SEEN MOVIES" PAGINATION ---
    const seenMoviesControls = document.getElementById('seen-movies-pagination-controls');
    if (seenMoviesControls) {
        const container = document.getElementById('seen-movies-container');
        const prevButton = document.getElementById('seen-prev-page');
        const nextButton = document.getElementById('seen-next-page');
        const currentPageSpan = document.getElementById('seen-current-page');
        const totalPagesSpan = document.getElementById('seen-total-pages');
        let currentPage = 1;
        const totalMovies = {{ total_seen_for_paging|default:0 }};
        const totalPages = Math.ceil(totalMovies / 12);
        totalPagesSpan.textContent = totalPages;

        function updateButtons() {
            prevButton.disabled = currentPage === 1;
            nextButton.disabled = currentPage === totalPages || totalPages === 0;
        }

        async function loadPage(page) {
            try {
                const response = await fetch(`/api/seen-movies-page/{{ profile_owner.username }}/${page}/`);
                if (!response.ok) throw new Error('API request failed');
                const data = await response.json();
                container.innerHTML = data.html;
                currentPage = page;
                currentPageSpan.textContent = page;
                updateButtons();
            } catch (error) { console.error('Error fetching seen movies page:', error); }
        }

        prevButton.addEventListener('click', () => { if (currentPage > 1) loadPage(currentPage - 1); });
        nextButton.addEventListener('click', () => { if (currentPage < totalPages) loadPage(currentPage + 1); });
        
        updateButtons();
    }

    // --- PART 2: LOGIC FOR "MY PROFILE" ONLY ---
    {% if is_self %}
        window.copyCode = function(elementId) {
            const input = document.getElementById(elementId); input.select(); document.execCommand('copy');
        }

        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        const csrfToken = getCookie('csrftoken');
        
        const totalSeenStat = document.getElementById('total-seen-movies-stat');
        const lastRatedContainer = document.getElementById('last-rated-container');

        if (lastRatedContainer) {
            lastRatedContainer.addEventListener('change', async function(event) {
                if (event.target.classList.contains('rating-toggle')) {
                    const checkbox = event.target;
                    const viewId = checkbox.dataset.viewId;
                    const newStatus = checkbox.checked;

                    try {
                        const response = await fetch('/api/update-rating/', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                            body: JSON.stringify({ view_id: viewId, new_status: newStatus })
                        });
                        const data = await response.json();
                        if (data.success) {
                            totalSeenStat.textContent = data.total_seen_movies;
                        }
                    } catch (error) { console.error('Error updating rating:', error); }
                }
            });

            const prevButton = document.getElementById('prev-page');
            const nextButton = document.getElementById('next-page');
            const currentPageSpan = document.getElementById('current-page');
            const totalPagesSpan = document.getElementById('total-pages');
            let currentPage = 1;
            const totalMovies = {{ total_last_rated|default:0 }};
            const totalPages = Math.ceil(totalMovies / 10);
            totalPagesSpan.textContent = totalPages;
            
            function updatePaginationButtons() {
                prevButton.disabled = currentPage === 1;
                nextButton.disabled = currentPage === totalPages || totalPages === 0;
            }
            async function loadPage(page) {
                try {
                    const response = await fetch(`/api/last-rated-page/${page}/`);
                    const data = await response.json();
                    lastRatedContainer.innerHTML = data.html;
                    currentPage = page;
                    currentPageSpan.textContent = currentPage;
                    updatePaginationButtons();
                } catch (error) { console.error('Error fetching page:', error); }
            }
            prevButton.addEventListener('click', () => { if (currentPage > 1) loadPage(currentPage - 1); });
            nextButton.addEventListener('click', () => { if (currentPage < totalPages) loadPage(currentPage + 1); });
            updatePaginationButtons();
        }
    {% endif %}
});
</script>

{% endblock content %}